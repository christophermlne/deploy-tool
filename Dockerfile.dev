# Development Dockerfile for deploy tool
# Usage: docker build -f Dockerfile.dev -t deploy-dev .
#        docker run -e GITHUB_TOKEN=xxx -e DEPLOY_REPO_URL=xxx deploy-dev mix deploy 123

FROM elixir:1.17-alpine

# Install git (required for repo operations)
RUN apk add --no-cache git build-base && \
    git config --global user.email "deploy-tool@localhost" && \
    git config --global user.name "Deploy Tool"

WORKDIR /app

# Copy dependency files first (for layer caching)
COPY mix.exs mix.lock ./

# Install all dependencies (including dev/test)
RUN mix local.hex --force && \
    mix local.rebar --force && \
    mix deps.get

# Copy source code
COPY config config
COPY lib lib
COPY test test
COPY assets assets
COPY priv priv
COPY .formatter.exs ./

# Install esbuild and tailwind, then compile
RUN mix compile && \
    mix esbuild.install && \
    mix tailwind.install

EXPOSE 4000

# Default command shows usage
CMD ["mix", "deploy", "--help"]
